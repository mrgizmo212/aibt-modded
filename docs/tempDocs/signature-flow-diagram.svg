<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1400 1800">
  <!-- Title -->
  <text x="700" y="40" font-size="28" font-weight="bold" text-anchor="middle" fill="#2c3e50">
    SIGNATURE Flow: How Intraday Trading Works
  </text>
  
  <!-- Section 1: User Makes Request -->
  <rect x="50" y="80" width="1300" height="120" fill="#e8f4f8" stroke="#3498db" stroke-width="2" rx="10"/>
  <text x="700" y="110" font-size="20" font-weight="bold" text-anchor="middle" fill="#2c3e50">
    1ï¸âƒ£ USER STARTS INTRADAY TRADING
  </text>
  
  <rect x="200" y="130" width="400" height="50" fill="#ffffff" stroke="#3498db" stroke-width="2" rx="5"/>
  <text x="400" y="160" font-size="16" text-anchor="middle" fill="#2c3e50">
    User ID: alice
  </text>
  
  <rect x="800" y="130" width="400" height="50" fill="#ffffff" stroke="#3498db" stroke-width="2" rx="5"/>
  <text x="1000" y="160" font-size="16" text-anchor="middle" fill="#2c3e50">
    Model ID: 169 ("alice-trader-v1")
  </text>
  
  <!-- Arrow down -->
  <line x1="700" y1="200" x2="700" y2="240" stroke="#34495e" stroke-width="3" marker-end="url(#arrowhead)"/>
  
  <!-- Section 2: Backend Creates Agent (THE FIX) -->
  <rect x="50" y="240" width="1300" height="220" fill="#d5f4e6" stroke="#27ae60" stroke-width="3" rx="10"/>
  <text x="700" y="270" font-size="20" font-weight="bold" text-anchor="middle" fill="#27ae60">
    2ï¸âƒ£ BACKEND CREATES AGENT + SETS SIGNATURE âœ… (THE FIX!)
  </text>
  
  <!-- Before Fix (Red X) -->
  <rect x="100" y="290" width="500" height="150" fill="#ffe6e6" stroke="#e74c3c" stroke-width="2" rx="5" stroke-dasharray="5,5"/>
  <text x="350" y="315" font-size="16" font-weight="bold" text-anchor="middle" fill="#e74c3c">
    âŒ BEFORE FIX (Broken)
  </text>
  <text x="350" y="345" font-size="14" text-anchor="middle" fill="#c0392b">
    1. Create agent
  </text>
  <text x="350" y="370" font-size="14" text-anchor="middle" fill="#c0392b">
    2. âš ï¸ SKIP setting SIGNATURE
  </text>
  <text x="350" y="395" font-size="14" text-anchor="middle" fill="#c0392b">
    3. Initialize agent
  </text>
  <text x="350" y="420" font-size="14" text-anchor="middle" fill="#c0392b">
    4. Start trading â†’ FAILS! ğŸ’¥
  </text>
  
  <!-- After Fix (Green Check) -->
  <rect x="800" y="290" width="500" height="150" fill="#e6ffe6" stroke="#27ae60" stroke-width="3" rx="5"/>
  <text x="1050" y="315" font-size="16" font-weight="bold" text-anchor="middle" fill="#27ae60">
    âœ… AFTER FIX (Working)
  </text>
  <text x="1050" y="345" font-size="14" text-anchor="middle" fill="#229954">
    1. Create agent
  </text>
  <text x="1050" y="370" font-size="14" font-weight="bold" text-anchor="middle" fill="#27ae60">
    2. âœ… SET SIGNATURE = "alice-trader-v1"
  </text>
  <text x="1050" y="395" font-size="14" font-weight="bold" text-anchor="middle" fill="#27ae60">
    3. âœ… SET TODAY_DATE = "2025-10-21"
  </text>
  <text x="1050" y="420" font-size="14" text-anchor="middle" fill="#229954">
    4. Initialize agent
  </text>
  
  <!-- Arrow down -->
  <line x1="700" y1="460" x2="700" y2="500" stroke="#34495e" stroke-width="3" marker-end="url(#arrowhead)"/>
  
  <!-- Section 3: Config Storage -->
  <rect x="50" y="500" width="1300" height="180" fill="#fff3cd" stroke="#f39c12" stroke-width="2" rx="10"/>
  <text x="700" y="530" font-size="20" font-weight="bold" text-anchor="middle" fill="#2c3e50">
    3ï¸âƒ£ SIGNATURE STORED (Multi-User Isolated)
  </text>
  
  <!-- Storage locations -->
  <rect x="150" y="550" width="450" height="100" fill="#ffffff" stroke="#f39c12" stroke-width="2" rx="5"/>
  <text x="375" y="575" font-size="16" font-weight="bold" text-anchor="middle" fill="#2c3e50">
    ğŸ“ File System
  </text>
  <text x="375" y="600" font-size="13" text-anchor="middle" fill="#7f8c8d">
    /data/.runtime_env_169.json
  </text>
  <text x="375" y="625" font-size="13" text-anchor="middle" fill="#27ae60">
    {"SIGNATURE": "alice-trader-v1"}
  </text>
  
  <rect x="800" y="550" width="450" height="100" fill="#ffffff" stroke="#f39c12" stroke-width="2" rx="5"/>
  <text x="1025" y="575" font-size="16" font-weight="bold" text-anchor="middle" fill="#2c3e50">
    â˜ï¸ Redis (Production)
  </text>
  <text x="1025" y="600" font-size="13" text-anchor="middle" fill="#7f8c8d">
    config:169:SIGNATURE
  </text>
  <text x="1025" y="625" font-size="13" text-anchor="middle" fill="#27ae60">
    â†’ "alice-trader-v1"
  </text>
  
  <!-- Arrow down -->
  <line x1="700" y1="680" x2="700" y2="720" stroke="#34495e" stroke-width="3" marker-end="url(#arrowhead)"/>
  
  <!-- Section 4: AI Trading Loop -->
  <rect x="50" y="720" width="1300" height="200" fill="#e8f4f8" stroke="#3498db" stroke-width="2" rx="10"/>
  <text x="700" y="750" font-size="20" font-weight="bold" text-anchor="middle" fill="#2c3e50">
    4ï¸âƒ£ AI MAKES TRADING DECISIONS (Minute-by-Minute)
  </text>
  
  <!-- Minute samples -->
  <rect x="100" y="770" width="180" height="60" fill="#ffffff" stroke="#3498db" stroke-width="2" rx="5"/>
  <text x="190" y="795" font-size="14" text-anchor="middle" fill="#2c3e50">
    09:30 â†’ BUY 13 IBM
  </text>
  <text x="190" y="815" font-size="12" text-anchor="middle" fill="#7f8c8d">
    @ $282.79
  </text>
  
  <rect x="320" y="770" width="180" height="60" fill="#ffffff" stroke="#3498db" stroke-width="2" rx="5"/>
  <text x="410" y="795" font-size="14" text-anchor="middle" fill="#2c3e50">
    09:37 â†’ SELL 9 IBM
  </text>
  <text x="410" y="815" font-size="12" text-anchor="middle" fill="#7f8c8d">
    @ $282.37
  </text>
  
  <rect x="540" y="770" width="180" height="60" fill="#ffffff" stroke="#3498db" stroke-width="2" rx="5"/>
  <text x="630" y="795" font-size="14" text-anchor="middle" fill="#2c3e50">
    09:40 â†’ HOLD
  </text>
  <text x="630" y="815" font-size="12" text-anchor="middle" fill="#7f8c8d">
    Wait for signal
  </text>
  
  <rect x="760" y="770" width="180" height="60" fill="#ffffff" stroke="#3498db" stroke-width="2" rx="5"/>
  <text x="850" y="795" font-size="14" text-anchor="middle" fill="#2c3e50">
    09:59 â†’ BUY 13 IBM
  </text>
  <text x="850" y="815" font-size="12" text-anchor="middle" fill="#7f8c8d">
    @ $282.79
  </text>
  
  <rect x="980" y="770" width="180" height="60" fill="#ffffff" stroke="#3498db" stroke-width="2" rx="5"/>
  <text x="1070" y="795" font-size="14" text-anchor="middle" fill="#2c3e50">
    ... 390 minutes
  </text>
  <text x="1070" y="815" font-size="12" text-anchor="middle" fill="#7f8c8d">
    Full trading day
  </text>
  
  <text x="700" y="900" font-size="14" font-style="italic" text-anchor="middle" fill="#7f8c8d">
    AI analyzes market data and decides: BUY, SELL, or HOLD
  </text>
  
  <!-- Arrow down -->
  <line x1="700" y1="920" x2="700" y2="960" stroke="#34495e" stroke-width="3" marker-end="url(#arrowhead)"/>
  
  <!-- Section 5: Trade Execution (WHERE SIGNATURE IS NEEDED!) -->
  <rect x="50" y="960" width="1300" height="280" fill="#ffe6f0" stroke="#e91e63" stroke-width="3" rx="10"/>
  <text x="700" y="990" font-size="20" font-weight="bold" text-anchor="middle" fill="#c2185b">
    5ï¸âƒ£ TRADE EXECUTION - SIGNATURE REQUIRED HERE! ğŸ”‘
  </text>
  
  <!-- MCP Tool Call -->
  <rect x="200" y="1010" width="400" height="80" fill="#ffffff" stroke="#e91e63" stroke-width="2" rx="5"/>
  <text x="400" y="1035" font-size="16" font-weight="bold" text-anchor="middle" fill="#c2185b">
    ğŸ¤– AI Calls: buy("IBM", 13)
  </text>
  <text x="400" y="1060" font-size="13" text-anchor="middle" fill="#7f8c8d">
    Via MCP subprocess on port 8002
  </text>
  <text x="400" y="1080" font-size="13" text-anchor="middle" fill="#7f8c8d">
    (Separate process from main backend)
  </text>
  
  <line x1="600" y1="1050" x2="700" y2="1050" stroke="#e91e63" stroke-width="3" marker-end="url(#arrowhead)"/>
  
  <!-- Trade Tool Logic -->
  <rect x="700" y="1010" width="500" height="220" fill="#fff9e6" stroke="#ff9800" stroke-width="2" rx="5"/>
  <text x="950" y="1035" font-size="16" font-weight="bold" text-anchor="middle" fill="#ff6f00">
    ğŸ”§ Trade Tool (tool_trade.py)
  </text>
  
  <text x="950" y="1065" font-size="14" text-anchor="middle" fill="#2c3e50">
    Step 1: Get SIGNATURE ğŸ”‘
  </text>
  <rect x="750" y="1075" width="400" height="30" fill="#e1f5fe" stroke="#0288d1" stroke-width="1" rx="3"/>
  <text x="950" y="1095" font-size="12" text-anchor="middle" font-family="monospace" fill="#01579b">
    signature = get_config_value("SIGNATURE")
  </text>
  
  <text x="950" y="1125" font-size="14" text-anchor="middle" fill="#2c3e50">
    Step 2: Find user's data folder ğŸ“
  </text>
  <rect x="750" y="1135" width="400" height="30" fill="#e1f5fe" stroke="#0288d1" stroke-width="1" rx="3"/>
  <text x="950" y="1155" font-size="12" text-anchor="middle" font-family="monospace" fill="#01579b">
    /data/agent_data/alice-trader-v1/
  </text>
  
  <text x="950" y="1185" font-size="14" text-anchor="middle" fill="#2c3e50">
    Step 3: Update positions âœï¸
  </text>
  <rect x="750" y="1195" width="400" height="30" fill="#e1f5fe" stroke="#0288d1" stroke-width="1" rx="3"/>
  <text x="950" y="1215" font-size="12" text-anchor="middle" font-family="monospace" fill="#01579b">
    Write to position.jsonl (alice's file)
  </text>
  
  <!-- Arrow down -->
  <line x1="700" y1="1240" x2="700" y2="1280" stroke="#34495e" stroke-width="3" marker-end="url(#arrowhead)"/>
  
  <!-- Section 6: Multi-User Isolation -->
  <rect x="50" y="1280" width="1300" height="260" fill="#f3e5f5" stroke="#9c27b0" stroke-width="2" rx="10"/>
  <text x="700" y="1310" font-size="20" font-weight="bold" text-anchor="middle" fill="#7b1fa2">
    6ï¸âƒ£ MULTI-USER ISOLATION (How Users Stay Separated)
  </text>
  
  <!-- User 1 -->
  <rect x="100" y="1330" width="350" height="190" fill="#e8f5e9" stroke="#4caf50" stroke-width="2" rx="5"/>
  <text x="275" y="1355" font-size="16" font-weight="bold" text-anchor="middle" fill="#2e7d32">
    ğŸ‘¤ User: Alice (Model 169)
  </text>
  <text x="275" y="1380" font-size="13" text-anchor="middle" fill="#2c3e50">
    SIGNATURE: "alice-trader-v1"
  </text>
  <line x1="120" y1="1390" x2="430" y2="1390" stroke="#4caf50" stroke-width="1"/>
  <text x="275" y="1410" font-size="12" text-anchor="middle" fill="#2c3e50">
    ğŸ“ /data/.runtime_env_169.json
  </text>
  <text x="275" y="1430" font-size="12" text-anchor="middle" fill="#2c3e50">
    â˜ï¸ Redis: config:169:SIGNATURE
  </text>
  <text x="275" y="1450" font-size="12" text-anchor="middle" fill="#2c3e50">
    ğŸ’° Cash: $10,000
  </text>
  <text x="275" y="1470" font-size="12" text-anchor="middle" fill="#2c3e50">
    ğŸ“Š IBM: 17 shares
  </text>
  <text x="275" y="1495" font-size="11" font-weight="bold" text-anchor="middle" fill="#27ae60">
    âœ… Her trades â†’ Her portfolio only
  </text>
  
  <!-- User 2 -->
  <rect x="550" y="1330" width="350" height="190" fill="#e3f2fd" stroke="#2196f3" stroke-width="2" rx="5"/>
  <text x="725" y="1355" font-size="16" font-weight="bold" text-anchor="middle" fill="#1565c0">
    ğŸ‘¤ User: Bob (Model 270)
  </text>
  <text x="725" y="1380" font-size="13" text-anchor="middle" fill="#2c3e50">
    SIGNATURE: "bob-aggressive-v2"
  </text>
  <line x1="570" y1="1390" x2="880" y2="1390" stroke="#2196f3" stroke-width="1"/>
  <text x="725" y="1410" font-size="12" text-anchor="middle" fill="#2c3e50">
    ğŸ“ /data/.runtime_env_270.json
  </text>
  <text x="725" y="1430" font-size="12" text-anchor="middle" fill="#2c3e50">
    â˜ï¸ Redis: config:270:SIGNATURE
  </text>
  <text x="725" y="1450" font-size="12" text-anchor="middle" fill="#2c3e50">
    ğŸ’° Cash: $25,000
  </text>
  <text x="725" y="1470" font-size="12" text-anchor="middle" fill="#2c3e50">
    ğŸ“Š AAPL: 50 shares
  </text>
  <text x="725" y="1495" font-size="11" font-weight="bold" text-anchor="middle" fill="#1976d2">
    âœ… His trades â†’ His portfolio only
  </text>
  
  <!-- User 3 -->
  <rect x="1000" y="1330" width="350" height="190" fill="#fce4ec" stroke="#ec407a" stroke-width="2" rx="5"/>
  <text x="1175" y="1355" font-size="16" font-weight="bold" text-anchor="middle" fill="#c2185b">
    ğŸ‘¤ User: Carol (Model 385)
  </text>
  <text x="1175" y="1380" font-size="13" text-anchor="middle" fill="#2c3e50">
    SIGNATURE: "carol-conservative"
  </text>
  <line x1="1020" y1="1390" x2="1330" y2="1390" stroke="#ec407a" stroke-width="1"/>
  <text x="1175" y="1410" font-size="12" text-anchor="middle" fill="#2c3e50">
    ğŸ“ /data/.runtime_env_385.json
  </text>
  <text x="1175" y="1430" font-size="12" text-anchor="middle" fill="#2c3e50">
    â˜ï¸ Redis: config:385:SIGNATURE
  </text>
  <text x="1175" y="1450" font-size="12" text-anchor="middle" fill="#2c3e50">
    ğŸ’° Cash: $50,000
  </text>
  <text x="1175" y="1470" font-size="12" text-anchor="middle" fill="#2c3e50">
    ğŸ“Š SPY: 100 shares
  </text>
  <text x="1175" y="1495" font-size="11" font-weight="bold" text-anchor="middle" fill="#d81b60">
    âœ… Her trades â†’ Her portfolio only
  </text>
  
  <!-- Summary Box -->
  <rect x="50" y="1560" width="1300" height="200" fill="#f0f4f8" stroke="#34495e" stroke-width="2" rx="10"/>
  <text x="700" y="1590" font-size="22" font-weight="bold" text-anchor="middle" fill="#2c3e50">
    ğŸ”‘ KEY TAKEAWAYS
  </text>
  
  <text x="700" y="1625" font-size="15" text-anchor="middle" fill="#2c3e50">
    âœ… SIGNATURE = Unique ID for each trading model (like a name tag)
  </text>
  <text x="700" y="1650" font-size="15" text-anchor="middle" fill="#2c3e50">
    âœ… The Bug: Intraday trading forgot to set SIGNATURE before starting
  </text>
  <text x="700" y="1675" font-size="15" text-anchor="middle" fill="#2c3e50">
    âœ… The Fix: Now sets SIGNATURE at line 968 in main.py (before agent initializes)
  </text>
  <text x="700" y="1700" font-size="15" text-anchor="middle" fill="#2c3e50">
    âœ… User Isolation: Each model has separate SIGNATURE, data folder, and Redis namespace
  </text>
  <text x="700" y="1730" font-size="15" font-weight="bold" text-anchor="middle" fill="#27ae60">
    ğŸ¯ Result: AI can now execute trades! No more "SIGNATURE not set" errors!
  </text>
  
  <!-- Arrow marker definition -->
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#34495e"/>
    </marker>
  </defs>
</svg>

